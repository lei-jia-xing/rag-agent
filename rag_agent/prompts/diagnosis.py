"""诊断报告生成的增强 Prompt 模板

多阶段生成策略：
- Stage 1: 核心评估 (health_score, health_status, risk_level)
- Stage 2: 故障分析 + 风险分析
- Stage 3: 分组字段生成 (设备信息、监测数据、维护建议)
- Stage 4: 一致性校验与修正
"""

HEALTH_SCORE_CRITERIA = """
健康评分标准（0-100分）：

【90-100分】优秀 - 设备状态良好
- 所有监测参数在正常范围内
- 无异常振动、温升、噪音
- 绝缘电阻、介质损耗等指标优良
- 无历史故障记录或已完全修复

【75-89分】良好 - 轻微异常
- 个别参数接近警戒值但未超标
- 存在轻微磨损但不影响运行
- 可能需要预防性维护

【60-74分】警告 - 需要关注
- 部分参数超出正常范围
- 存在明显磨损或老化迹象
- 建议尽快安排检修
- 可能存在潜在故障风险

【40-59分】异常 - 需要处理
- 多个参数异常
- 存在明显故障征兆
- 需要限制运行或降负荷
- 应立即安排维修

【0-39分】严重 - 紧急处理
- 关键参数严重超标
- 存在安全隐患
- 建议停机检修
- 可能导致设备损坏或事故
"""

SCORE_STATUS_MAPPING = """
评分与状态对应关系：
- health_score >= 75: health_status = "正常", risk_level = "低"
- health_score >= 60: health_status = "警告", risk_level = "中"
- health_score >= 40: health_status = "异常", risk_level = "高"
- health_score < 40: health_status = "严重", risk_level = "高"
"""

CORE_ASSESSMENT_PROMPT = f"""你是一名资深电气设备诊断专家，拥有20年以上的现场经验。

请基于提供的设备文档和检测数据，进行专业的健康评估。

{HEALTH_SCORE_CRITERIA}

{SCORE_STATUS_MAPPING}

**输出要求**：返回纯 JSON，包含以下字段：
{{{{
    "health_score": <0-100整数>,
    "health_status": "<正常|警告|异常|严重>",
    "risk_level": "<低|中|高>",
    "issue_count": <发现的问题数量>,
    "assessment_reasoning": "<评分依据，说明为什么给出这个分数，列举关键证据>"
}}}}

注意：
1. 评分必须有充分的依据，不要凭空猜测
2. 如果文档信息不足，评分应偏保守（偏低）
3. assessment_reasoning 必须详细说明评分理由

【格式警告】所有字符串值必须是纯文本，禁止使用任何 Markdown 格式（如 **粗体**、# 标题、- 列表、`代码`）。
输出将直接用于 LaTeX 排版，Markdown 语法会导致排版错误。使用中文标点和换行符来组织内容。"""

FAULT_ANALYSIS_PROMPT = """你是一名电气设备故障诊断专家。

基于设备文档和核心评估结果，进行详细的故障分析。

**输出要求**：返回纯 JSON，包含以下字段：

{{{{
    "fault_description": "<故障现象描述，200-400字>
        具体描述观察到的异常现象；
        包括时间、频率、严重程度；
        引用具体的监测数据或检测结果",

    "fault_cause_analysis": "<故障原因分析，300-500字>
        分析可能的根本原因（不少于3个可能原因）；
        按可能性从高到低排列；
        说明判断依据",

    "fault_location": "<故障定位>
        明确指出故障发生的具体部位；
        如：绕组、铁芯、套管、冷却系统等"
}}}}

如果设备状态正常（无故障），也需要说明：
fault_description: "设备运行正常，未发现明显故障征兆"
fault_cause_analysis: "暂无故障，建议继续监测"
fault_location: "无"

【格式警告】所有字符串值必须是纯文本，禁止使用任何 Markdown 格式（如 **粗体**、# 标题、- 列表、`代码`）。
输出将直接用于 LaTeX 排版，Markdown 语法会导致排版错误。使用中文标点、分号、句号和换行符来组织内容。
"""

RISK_ANALYSIS_PROMPT = """你是一名电气设备风险评估专家。

基于设备文档、核心评估和故障分析结果，进行风险评估。

**输出要求**：返回纯 JSON，包含以下字段：

{{{{
    "current_risks": "<当前风险，200-300字>
        列举当前存在的风险点（至少3项）；
        每项风险说明其可能后果；
        按严重程度排序",

    "potential_risks": "<潜在风险，200-300字>
        如果不采取措施，未来可能发展的风险；
        考虑设备老化、负荷变化等因素；
        预估风险发生的时间范围",

    "risk_control": "<风险控制建议，200-300字>
        针对每项风险提出控制措施；
        区分紧急措施和长期措施；
        明确责任部门和执行时限"
}}}}

【格式警告】所有字符串值必须是纯文本，禁止使用任何 Markdown 格式（如 **粗体**、# 标题、- 列表、`代码`）。
输出将直接用于 LaTeX 排版，Markdown 语法会导致排版错误。使用中文标点、分号、句号和换行符来组织内容。
"""

DEVICE_INFO_PROMPT = """你是一名电气设备档案管理专家。

基于设备文档，提取和整理设备基本信息。

**输出要求**：返回纯 JSON，包含以下字段：

{{{{
    "title": "设备健康诊断报告",
    "report_id": "<报告编号，格式：DX-YYYYMMDD-NNN>",
    "device_name": "<设备名称>",
    "device_model": "<设备型号，如文档中无则填'待补充'>",
    "location": "<安装位置>",
    "diagnosis_date": "<诊断日期，格式：YYYY年MM月DD日>",
    "data_range": "<数据采集范围，如：2024年1月-2024年6月>",

    "device_basic_info": "<设备基本信息，150-250字>
        制造商、出厂日期、投运日期；
        主要技术规格（额定容量、电压等级等）；
        设备编号、资产编号",

    "operating_environment": "<运行环境，100-150字>
        安装环境（室内/室外、海拔、温湿度）；
        运行工况（负荷率、运行小时数）；
        周边环境（污染等级、雷电活动等）",

    "maintenance_history": "<历史维护记录，150-200字>
        最近的维护保养时间和内容；
        历史故障及处理情况；
        大修或技改记录"
}}}}

注意：如果文档中缺少某项信息，应注明"文档中未提供"，不要编造数据。

【格式警告】所有字符串值必须是纯文本，禁止使用任何 Markdown 格式（如 **粗体**、# 标题、- 列表、`代码`）。
输出将直接用于 LaTeX 排版，Markdown 语法会导致排版错误。使用中文标点、分号、句号和换行符来组织内容。
"""

MONITORING_PROMPT = """你是一名电气设备状态监测专家。

基于设备文档和检测数据，整理监测分析结果。

**输出要求**：返回纯 JSON，包含以下字段：

{{{{
    "monitoring_data_summary": "<监测数据汇总，200-300字>
        列举主要监测项目和数据；
        按类别分段描述；
        标注数据采集时间",

    "key_metrics_analysis": "<关键指标分析，250-350字>
        分析各项关键指标的状态；
        与标准值或历史数据对比；
        指出异常或接近警戒的指标",

    "trend_analysis": "<趋势分析，200-300字>
        分析关键指标的变化趋势；
        预测未来可能的发展方向；
        识别需要关注的恶化趋势",

    "anomaly_detection": "<异常检测，150-250字>
        明确列出检测到的异常；
        说明异常的严重程度；
        分析异常的可能原因"
}}}}

【格式警告】所有字符串值必须是纯文本，禁止使用任何 Markdown 格式（如 **粗体**、# 标题、- 列表、`代码`、表格）。
输出将直接用于 LaTeX 排版，Markdown 语法会导致排版错误。使用中文标点、分号、句号和换行符来组织内容。
"""

MAINTENANCE_PROMPT = """你是一名电气设备维护管理专家。

基于设备状态评估和故障分析，制定维护建议。

**输出要求**：返回纯 JSON，包含以下字段：

{{{{
    "urgent_measures": "<紧急处理措施>
        如果设备状态严重，列出需要立即执行的措施；
        明确执行时限（如：24小时内、48小时内）；
        如无紧急措施，填写'暂无需紧急处理'",

    "maintenance_plan": "<维护计划，200-300字>
        短期维护计划（1个月内）；
        中期维护计划（3-6个月）；
        长期维护计划（年度）；
        每项计划说明具体内容和预期效果",

    "spare_parts_suggestion": "<备件建议，100-150字>
        建议储备的备品备件；
        说明数量和规格；
        标注优先级",

    "conclusion_and_recommendations": "<结论与建议，200-300字>
        总结设备整体状态；
        提出核心建议（不超过5条）；
        明确后续工作重点",

    "technical_parameters": "<技术参数>
        列出关键技术参数及其当前值；
        标注正常范围",

    "related_standards": "<相关标准>
        引用的国家标准或行业标准；
        如：GB/T、DL/T、IEC等",

    "diagnosis_method": "<诊断方法说明，100-150字>
        说明本次诊断采用的方法和手段；
        使用的检测设备和技术"
}}}}

【格式警告】所有字符串值必须是纯文本，禁止使用任何 Markdown 格式（如 **粗体**、# 标题、- 列表、`代码`）。
输出将直接用于 LaTeX 排版，Markdown 语法会导致排版错误。使用中文标点、分号、句号和换行符来组织内容。
"""

VALIDATION_PROMPT = """你是一名质量控制专家，负责审核诊断报告的一致性。

请检查以下诊断数据是否存在逻辑矛盾或不一致：

**检查项目**：
1. health_score 与 health_status 是否匹配（按评分标准）
2. health_status 与 risk_level 是否一致
3. issue_count 与 fault_description 描述的问题数量是否匹配
4. urgent_measures 的紧迫程度与 risk_level 是否匹配
5. 各字段内容是否前后矛盾
6. 是否存在 Markdown 格式（**粗体**、# 标题、- 列表等），如有则需要清除

**输出要求**：返回纯 JSON：
{{{{
    "is_consistent": <true|false>,
    "issues": [
        {{{{"field": "<字段名>", "problem": "<问题描述>", "suggestion": "<修正建议>"}}}}
    ],
    "corrections": {{{{
        "<需要修正的字段名>": "<修正后的值，必须是纯文本，不含Markdown>"
    }}}}
}}}}

如果一切正常，返回：
{{{{"is_consistent": true, "issues": [], "corrections": {{{{}}}}}}}}

【格式警告】corrections 中的所有字符串值必须是纯文本，禁止使用任何 Markdown 格式。
"""

FEW_SHOT_EXAMPLE = """
**示例输入**：
设备名称：110kV主变压器
文档摘要：变压器油色谱分析显示乙炔含量为5ppm，氢气含量为150ppm，总烃含量为300ppm。
绝缘电阻测试结果正常，介质损耗角正切值为0.8%。近期负荷率约80%。

**示例输出（核心评估）**：
{{{{
    "health_score": 72,
    "health_status": "警告",
    "risk_level": "中",
    "issue_count": 2,
    "assessment_reasoning": "1. 油中乙炔含量5ppm超出注意值(1ppm)，提示可能存在放电性故障；2. 总烃含量300ppm接近警戒值，需要关注；3. 绝缘电阻和介损正常，绝缘状态良好。综合评估，设备存在潜在风险但未达到严重程度，给予72分（警告级别）。"
}}}}

**示例输出（故障分析）**：
{{{{
    "fault_description": "油色谱分析显示乙炔含量5ppm，超出GB/T 7252规定的注意值1ppm，表明变压器内部可能存在局部放电或电弧放电现象。氢气含量150ppm和总烃含量300ppm均有所升高，进一步印证了内部可能存在异常发热或放电问题。该异常首次发现于2024年3月例行检测中，目前呈缓慢上升趋势。",

    "fault_cause_analysis": "可能原因分析（按可能性排序）：1. 【高可能性】绕组匝间短路或引线接触不良，导致局部过热产生乙炔；2. 【中可能性】分接开关内部触头磨损或接触不良，引起电弧放电；3. 【低可能性】油纸绝缘老化，在电场作用下发生局部放电。建议进行进一步检测：包括局部放电测试、分接开关检查、油中溶解气体色谱趋势分析。",

    "fault_location": "根据气体特征判断，故障可能位于：1. 高压绕组区域（乙炔生成的主要区域）；2. 有载分接开关（如配备）。建议重点检查这两个部位。"
}}}}
"""
